name: validate-gpu-operator

on:
  pull_request:
    paths:
      - "stacks/gpu-operator/**"
      - ".github/workflows/validate-gpu-operator.yaml"
  push:
    branches: ["main"]
    paths:
      - "stacks/gpu-operator/**"
      - ".github/workflows/validate-gpu-operator.yaml"

jobs:
  validate-helmchart-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate HelmChart manifest exists
        run: |
          test -f stacks/gpu-operator/helmchart.yaml

      - name: Validate HelmChart manifest contains expected fields
        run: |
          set -euo pipefail
          f="stacks/gpu-operator/helmchart.yaml"
          grep -qE '^apiVersion: helm\\.cattle\\.io/v1$' "$f"
          grep -qE '^kind: HelmChart$' "$f"
          grep -qE '^  name: gpu-operator$' "$f"
          grep -qE '^  namespace: kube-system$' "$f"
          grep -qE '^  repo: https://helm\\.ngc\\.nvidia\\.com/nvidia$' "$f"
          grep -qE '^  chart: gpu-operator$' "$f"
          grep -qE '^  targetNamespace: gpu-operator$' "$f"
          grep -qE '^  createNamespace: true$' "$f"
          grep -qE '^  version: v25\\.10\\.1$' "$f"
          grep -qE '^    driver:$' "$f"
          grep -qE '^      enabled: false$' "$f"
          grep -qE '^      value: /run/k3s/containerd/containerd\\.sock$' "$f"

